import e from"../../gallery/mx-dragdrop/index.js";import t from"../../lib/agent.js";import i from"../../lib/cron.js";import a from"../../lib/magix.js";a.applyStyle("xl-m",".xl-aM{background:#0008;border-radius:2px;box-shadow:0 -1px 0 3px #0008;font-size:12px;height:160px;overflow:auto;padding:2px 4px}.xl-aN{opacity:.1}.xl-aO{border-radius:2px;cursor:pointer;float:left;line-height:20px;margin:0 4px;padding:0 6px;width:322px}.xl-aO:hover{background-color:#fff2}.xl-aP::-webkit-scrollbar{height:0;width:0}.xl-aP:hover::-webkit-scrollbar{width:2px}.xl-aP::-webkit-scrollbar-corner{height:0;width:0}.xl-aP::-webkit-scrollbar-thumb{background:#fff7;border-radius:2px}.xl-aP::-webkit-scrollbar-thumb:hover{background:#fff}.xl-aQ{border:1px solid #fff4;border-radius:2px;height:14px;padding:1px;position:absolute;width:15px;z-index:10000}");let s=(e,t)=>Date.parse(t.ctime)-Date.parse(e.ctime),l=a.guid("_aK"),r={_w(e,t){let i=a.node(l);i||(i=document.createElement("div"),i.id=l,i.innerHTML='<svg viewBox="0 0 1052 1024"><path d="M454.438 1024C302.958 835.56 124.213 693.17 0 648.331l294.779-176.927 142.087 276.298S668.326 186.925 1033.998 0c-7.877 133.605-44.232 249.335 18.48 392.028C891.91 428.383 562.594 828.895 454.438 1024z" fill="green"/></svg>',i.className="xl-aQ",document.body.appendChild(i));let s=i.style;s.display="",s.left=e+12+"px",s.top=t+8+"px"},_B(){let e=a.node(l);e&&(e.style.display="none")}};export default a.View.extend({tmpl:(e,t,i,a,s,l)=>{let r,o,d,p,{news:n}=e;p=[];for(let e=n.length,a=0;a<e;a+=1){let e=n[a];d=[t(0,e.title)],p.push(t("div",{class:"xl-L xl-aO",title:e.title+"\n\u6765\u6e90\uff1a"+e.source+"\r\u65e5\u671f\uff1a"+e.ctime,"mx5-click":i+"\x1e_aP({n:'"+l(s,e,"_."+a+".a")+"',i:"+a+"})","mx5-mousedown":i+"\x1e_aQ({i:"+a+"})"},d))}return o="xl-aM xl-aP",n.length||(o+=" xl-aN"),r=[t("div",{id:"s_"+i,class:o},p)],t(i,0,r)},init(){let e=this.render.bind(this);i._s(e,18e5,!1,"_aL"),this.on("destroy",(()=>{i._t(e)})),this.set({news:[]}),this._aM={}},assign:()=>!1,async render(){let e=a.mark(this,"_aN");try{let i=await t.request("//api.tianapi.com/topnews/index?key=b9b7f0a5e92206c91cb09d93c4c24ca4"),l=JSON.parse(i);if(l&&l.newslist&&e()){let t=this.get("news"),i=this._aM,r=l.newslist;for(let e of r)i[e.title]||(i[e.title]=1,t.push(e));if(t=t.sort(s),t.splice(50,100),await this.digest({news:t}),e()){a.node(`s_${this.id}`).scrollTop=0}}}catch(e){}},"_aP<click>"(e){if(!this._aO){let{n:t,i:i}=e.params;window.open(t.url);let a=this.get("news");a.splice(i,1),this.digest({news:a})}},"_aQ<mousedown>"(e){let t,{i:i}=e.params,s=!1;this._d(e,(i=>{s=s||Math.abs(i.pageX-e.pageX)>10||Math.abs(i.pageY-e.pageY)>10,s&&(this._aO=1,a.inside(i.target,this.root)?t&&(t=0,r._B()):(t=1,r._w(i.pageX,i.pageY)))}),(e=>{if(!a.inside(e.target,this.root)){let e=this.get("news");e.splice(i,1),this.digest({news:e})}r._B(),setTimeout((()=>{delete this._aO}))}))}}).merge(e);