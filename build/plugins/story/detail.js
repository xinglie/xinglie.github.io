import"./story.js";let s;import t from"../../lib/magix.js";import l from"../../lib/agent.js";let e=/<dt>\s*<span>([\s\S]+?)<\/span>\s*<\/dt>\s*([\s\S]+?)<\/dl>/g,i=/<dd>\s*<span\s*class="maglisttitle">\s*<a[^>]*?href="([^"]+)"[^>]*?>([\s\S]+?)<\/a>\s*<\/span>\s*<\/dd>/g;export default t.View.extend({tmpl:(t,l,e,i,r,a,o)=>{let d,h,n,p=[],{loading:g,error:u,showStory:x,list:m,storyUrl:c}=t;if(g)s?p.push(s):(d=[l(0,"loading...")],p.push(s=l("div",{_:"_",class:"xl-w"},d)));else if(u)p.push(l(0,u));else{d=[];for(let s=m.length,t=0;t<s;t+=1){let s=m[t];n=[l(0,s.title)],d.push(l("div",{class:"xl-bS",title:s.title},n));for(let t=s.links,i=t.length,r=0;r<i;r+=1){let s=t[r];n=[l(0,s.text)],d.push(l("div",{class:"xl-bT",title:s.text,"mx5-click":e+"\x1e_bX({url:'"+o(s.url)+"'})"},n))}}h="xl-bR",x&&(h+=" xl-bU"),p.push(l("div",{class:h},d))}return h="xl-bV",x&&(h+=" xl-bW"),p.push(l("div",{"mx5-owner":e,"mx5-from":e,"mx5-view":"~xl/plugins/story/story?url="+i(c),"mx5-close":e+"\x1e_bY()",class:h})),l(e,0,p)},init(){this.set({showStory:!1,storyUrl:""})},assign(s){return this.set(s).set({loading:!0,showStory:!1}),!0},async render(){this.digest();try{let s=t.mark(this,"_aH"),r=this.get("data"),a=r.lastIndexOf("/"),o=r.substring(0,a+1),d=await l.request(r,2592e6,!0);if(s()){let s=[];d.replace(e,((t,l,e)=>{let r=[];return e.replace(i,((s,t,l)=>(r.push({url:o+t,text:l.trim()}),s))),s.push({title:l.trim(),links:r}),t})),this.digest({list:s,loading:!1})}}catch(s){this.digest({loading:!1,error:s})}},"_bX<click>"(s){this.digest({showStory:!0,storyUrl:s.params.url})},"_bY<close>"(){this.digest({showStory:!1})}});