let t;import e from"../../lib/magix.js";import i from"./player.js";let s=/((?:\[[0-9:\.]+\])+)([^\r\n]*)/g,l=/\[offset\s*:\s*(\d+)\]/i,h=/\[([0-9\.:]+)\]/g,o=(t,e)=>t.time-e.time,b=[{text:""},{text:"\u6b4c\u8bcd\u52a0\u8f7d\u4e2d..."}],r=[{text:""},{text:"\u83b7\u53d6\u6b4c\u8bcd\u5931\u8d25"}];export default e.View.extend({tmpl:(e,i,s)=>{let l,h,o,b,r=[],{lyrics:_,topmost:a}=e;for(let t=_.length,e=0;e<t;e+=1){let t=_[e];h=[i(0,t.text)],l="xl-bv",t.active&&(l+=" xl-bw"),r.push(i("div",{title:t.text,class:l},h))}return t?h=[t]:(b=[i(0,'<path fill="#fff" d="M511.927 261.389l192.538 192.54H319.388l192.539-192.54zm-76.868 192.588h154.032v231.045H435.059V453.977zM319.535 723.825h385.077v38.51H319.535v-38.51z"/>',1)],h=[t=i("svg",{_:"_",viewBox:"0 0 1024 1024"},b)]),l="xl-bl xl-bx",a&&(l+=" xl-bn"),o="",o+=a?"\u7a97\u53e3\u5df2\u7f6e\u9876":"\u70b9\u51fb\u7f6e\u9876\u7a97\u53e3",r.push(i("span",{"mx5-click":s+"\x1e_bo()","mx5-mousedown":s+"\x1e_bn()",class:l,title:o},h)),i(s,0,r)},init(){i.on("_aZ",(t=>{this._bd(t.song)})),i.on("_be",(t=>{this._bf(t.current)})),i.on("_a0",(()=>{this._bg()})),this.set({topmost:!1})},_bg(){delete this._bh,delete this._bi,delete this._bj,delete this._bk,delete this._bl,this._bf(0)},async _bd(t){let b=e.mark(this,"_bd");try{let{lyric:e}=await i._bm(t);b()&&(this._bh=(t=>{let e=0,i=[];return t.replace(l,((t,i)=>(e=parseFloat(i)/1e3,""))).replace(s,((t,s,l)=>{s.replace(h,((t,s)=>{let h=0,o=(s=s.split(":")).length-1;for(let t=0;t<=o;t++)h+=s[t]*Math.pow(60,o-t);h-=e,isNaN(h)||i.push({time:h,text:l})}))})),i.length<2&&i.push({time:-1,text:""}),i=i.sort(o),i})(e))}catch(t){this._bl=!0}},_bf(t){let e=this._bh;if(e){let i=0,s=[];for(;i<e.length;i++){if(e[i].time>t)break}let l=Math.ceil(1.5),h=Math.floor(1.5),o=Math.max(i-l,0),b=Math.min(e.length,i+h);if(0==o&&e.length>2&&b-o<3&&b++,b==e.length&&e.length>2&&b-o<3&&o--,i-=1,i<0&&(i=0),this._bj!=b||this._bi!=o||this._bk!=i){this._bj=b,this._bi=o,this._bk=i;for(let t=o;t<b;t++)s.push({text:e[t].text,active:t==i});this.digest({lyrics:s})}}else this.digest({lyrics:this._bl?r:b})},render(){this.digest({lyrics:b})},"_bn<mousedown>"(t){t.stopPropagation()},"_bo<click>"(){let t=!this.get("topmost");this.root.style.zIndex=t?"60000":"",this.digest({topmost:t})}});