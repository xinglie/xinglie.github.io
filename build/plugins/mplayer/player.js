import e from"../../lib/magix.js";import t from"../../lib/agent.js";let s="//api2.jirengu.com/fm/v2",i=[],a=[],h=[{name:"\u70ed\u6b4c\u699c",channel_id:"netease_1"},{name:"\u65b0\u6b4c\u699c",channel_id:"netease_2"},{name:"\u6296\u97f3\u699c",channel_id:"netease_4"},{name:"\u7535\u97f3\u699c",channel_id:"netease_5"}],n=e.toMap(h,"channel_id");export default Object.assign({_bp(){let e=[];for(let t of h){let s={...t};s.name="\u7f51\u6613-"+t.name,s.cover_small="//s.geci.me/album-cover/336/3368702.jpg",e.push(s)}return e},_bq:()=>t.request(`${s}/getChannels.php`,864e5),_br(t){if((t+"").startsWith("netease_")){let s=n[t];return fetch("https://api.uomg.com/api/rand.music?sort="+s.name+"&format=json").then((e=>e.json())).then((t=>({song:[{artist:t.data.artistsname,url:t.data.url,title:t.data.name,picture:t.data.picurl,sid:e.guid("ns_"),from:"netease"}]})))}return fetch(`${s}/getSong.php?channel=${t}`).then((e=>e.json()))},_bm(e){if("netease"==e.from){let s,i=/id=([^.]+)/;return e.url.replace(i,((e,t)=>s=t)),t.request(`http://music.163.com/api/song/media?id=${s}`,0,!0).then((e=>JSON.parse(e)))}let i=`${s}/getLyric.php?sid=${e.sid}`;return fetch(i).then((e=>e.json()))},async _aT(){let e=await this._bq(),t=JSON.parse(e),{channels:s}=t,i=this._bp();return s.push(...i),{active:s[0],channels:s}},_bw(t){if(this._bs){clearTimeout(this._bt);let s=this._bu;s||(s={play:!1,buffer:!1});let i=["play","buffer"];for(let a of i)e.has(t,a)||(t[a]=s[a]);this._bu=t,this._bt=setTimeout((()=>{let e=!1;if(s=this._bv,s){for(let a of i)if(s[a]!=t[a]){e=!0;break}}else e=!0;e&&this.fire("_aY",this._bv=t)}),50)}},_bx(){let e=this._bs;if(e){let t=e.buffered,s=0;t.length&&(s=t.end(t.length-1)/e.duration),this.fire("_be",{duration:e.duration,current:e.currentTime,buffered:s})}},_bB(){if(!this._bs){let e,t=new Audio;t.onprogress=e=>{this._bx()},t.onerror=()=>{clearTimeout(e),e=setTimeout((()=>{this.fire("_aV")}),2e3)},t.onended=()=>{clearTimeout(e),e=setTimeout((()=>{this.fire("_aV")}),1e3)},t.onvolumechange=()=>{this.fire("_by",{volume:t.volume})},t.oncanplay=()=>{this._bw({buffer:!1})},t.onwaiting=()=>{this._bw({buffer:!0})},t.ontimeupdate=()=>{this._bz||this._bx()},t.onplaying=()=>{this._bw({play:!0})},t.ondurationchange=()=>{this._bz||this._bx()},t.onpause=()=>{this._bw({play:t.ended})},t.onloadedmetadata=()=>{let e=this._bA,t=!1;for(let s of a)if(s.sid==e.sid){t=!0;break}if(!t)for(let s of i)if(s.sid==e.sid){t=!0;break}t||a.push(e),a.length>50&&a.shift(),this.fire("_aZ",{song:e})},this._bs=t}},_bC(e){this._bB(),this._bs.src=e.url,this._bs.play().catch((e=>{})),this._bA=e},_bD(e){if(this._bs){let t=this._bs.seekable,s=t.length;if(s){let i=t.start(0),a=t.end(s-1);e>=i&&e<=a&&(this._bs.currentTime=e)}else{let e=this._bs.buffered;if(e.length){let t=e.end(e.length-1);this._bs.currentTime=t}}}},_bF(e,t,s){clearTimeout(this._bE),this._bE=setTimeout((()=>{this._aW(e,t)}),s)},async _aW(t,s){if(clearTimeout(this._bE),this._a3(),this._bw({buffer:!0}),s||(s=0==i.length),s)try{let i=e.mark(this,"_aW"),{song:a}=await this._br(t);if(i()){let e=a[0];e&&e.url?(this.fire("_a0",{song:e}),this._bC(e)):this._bF(t,s,5e3)}}catch(e){this._bF(t,s,2e3)}else{let e=i.pop();a.push(e),this._bC(e),this.fire("_a0",{song:e})}},_a4(){if(a.length>1){this._a3(),this._bw({buffer:!0});let e=a.pop();i.push(e),e=a[a.length-1],this._bC(e),this.fire("_a0",{song:e})}},_a1(){return this._bs},_a7:()=>a.length>1,_bG(e){this._bs&&(this._bs.volume=e)},_a3(){this._bs&&this._bs.pause()},_a2(){this._bs&&this._bs.play()},_bH(){let e=this._bs;return!!e&&(e.muted=!e.muted,e.muted)},_aX(){this._bs&&(this._bs.currentTime=0,this._bs.play())},_a5(){if(a.length>1){let e=a[a.length-2];return"\u4e0a\u4e00\u9996\uff1a"+e.title+"-"+e.artist}return"\u4e0a\u4e00\u9996\uff1a\u6682\u65e0\u5386\u53f2\u6b4c\u66f2"},_a6(){if(i.length){let e=i[i.length-1];return"\u4e0b\u4e00\u9996\uff1a"+e.title+"-"+e.artist}return"\u4e0b\u4e00\u9996\uff1a\u968f\u673a\u6b4c\u66f2"},_bc(e){this._bz=e,e||this._bx()}},e.Event);